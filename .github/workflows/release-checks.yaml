name: Release checks

on:
  pull_request:
    branches:
      - release

jobs:
  pr-title:
    name: Validate PR title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          echo "Checking PR title: $TITLE"

          # Must be exactly "Release X.Y.Z" or "Release X.Y.Z-suffix"
          if [[ ! "$TITLE" =~ ^Release\ [0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "::error::PR title must be 'Release X.Y.Z' or 'Release X.Y.Z-suffix' (e.g., 'Release 0.10.4-horse.8.0')"
            exit 1
          fi

          echo "PR title is valid."

  diff-check:
    name: Verify diff matches main
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check diff with main
        run: |
          git fetch origin main

          # Get the diff between the PR branch and main
          DIFF=$(git diff origin/main..HEAD)

          if [ -n "$DIFF" ]; then
            echo "::error::PR branch has changes that differ from main. The release branch must contain exactly what is in main."
            echo "Diff:"
            echo "$DIFF"
            exit 1
          fi

          echo "PR branch matches main exactly."

  version:
    name: Validate version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version file exists
        run: |
          if [ ! -f "VERSION" ]; then
            echo "::error::VERSION file not found"
            exit 1
          fi
          echo "VERSION file exists."

      - name: Check version bump
        run: |
          git fetch origin release || true

          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "Current version: $VERSION"

          # Check if this version tag already exists
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "::error::Tag v$VERSION already exists. Please bump the version."
            exit 1
          fi

          echo "Version $VERSION is new."

      - name: Check changelog entry
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')

          # Check if changelog has an entry for this version
          if ! grep -q "## \`$VERSION\`" CHANGELOG.md; then
            echo "::error::CHANGELOG.md does not have an entry for version $VERSION"
            echo "Expected to find: ## \`$VERSION\`"
            exit 1
          fi

          echo "Changelog entry found for version $VERSION."

      - name: Verify PR title matches VERSION
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          EXPECTED_TITLE="Release $VERSION"
          ACTUAL_TITLE="${{ github.event.pull_request.title }}"

          if [ "$EXPECTED_TITLE" != "$ACTUAL_TITLE" ]; then
            echo "::error::PR title '$ACTUAL_TITLE' does not match VERSION file. Expected '$EXPECTED_TITLE'"
            exit 1
          fi

          echo "PR title matches VERSION file."

      - name: Check Cargo.toml version matches
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          CARGO_VERSION=$(./scripts/get-version.sh)

          if [ "$VERSION" != "$CARGO_VERSION" ]; then
            echo "::error::VERSION file ($VERSION) does not match Cargo.toml ($CARGO_VERSION)"
            exit 1
          fi

          echo "VERSION file matches Cargo.toml."
